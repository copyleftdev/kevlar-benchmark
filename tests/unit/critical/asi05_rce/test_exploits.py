"""
Unit tests for ASI05 RCE exploit modules.
"""

import pytest

from kevlar.modules.critical.asi05_rce.exploits.shell_injection import ShellInjectionExploit
from kevlar.modules.critical.asi05_rce.exploits.vibe_coding_abuse import VibeCodingAbuse
from kevlar.modules.critical.asi05_rce.exploits.code_hallucination import CodeHallucinationExploit
from kevlar.modules.critical.asi05_rce.exploits.deserialization_attack import DeserializationAttack
from kevlar.modules.critical.asi05_rce.exploits.toolchain_rce import ToolchainRCE
from kevlar.modules.critical.asi05_rce.exploits.memory_eval_rce import MemoryEvalRCE
from kevlar.modules.critical.asi05_rce.exploits.agent_generated_backdoor import AgentGeneratedBackdoor
from kevlar.modules.critical.asi05_rce.exploits.lockfile_poisoning import LockfilePoisoning
from kevlar_types import SessionLog


class TestShellInjectionExploit:
    """Tests for ShellInjectionExploit."""

    def test_create_exploit(self, mock_agent):
        """Test creating exploit."""
        exploit = ShellInjectionExploit(mock_agent)
        assert exploit.agent is mock_agent

    def test_execute_returns_session(self, mock_agent):
        """Test execute returns session."""
        exploit = ShellInjectionExploit(mock_agent)
        result = exploit.execute()
        assert result is not None
        assert isinstance(result, SessionLog)


class TestVibeCodingAbuse:
    """Tests for VibeCodingAbuse."""

    def test_create_exploit(self, mock_agent):
        """Test creating exploit."""
        exploit = VibeCodingAbuse(mock_agent)
        assert exploit.agent is mock_agent

    def test_execute_returns_session(self, mock_agent):
        """Test execute returns session."""
        exploit = VibeCodingAbuse(mock_agent)
        result = exploit.execute()
        assert result is not None
        assert isinstance(result, SessionLog)


class TestCodeHallucinationExploit:
    """Tests for CodeHallucinationExploit."""

    def test_create_exploit(self, mock_agent):
        """Test creating exploit."""
        exploit = CodeHallucinationExploit(mock_agent)
        assert exploit.agent is mock_agent

    def test_execute_returns_session(self, mock_agent):
        """Test execute returns session."""
        exploit = CodeHallucinationExploit(mock_agent)
        result = exploit.execute()
        assert result is not None
        assert isinstance(result, SessionLog)


class TestDeserializationAttack:
    """Tests for DeserializationAttack."""

    def test_create_exploit(self, mock_agent):
        """Test creating exploit."""
        exploit = DeserializationAttack(mock_agent)
        assert exploit.agent is mock_agent

    def test_execute_returns_session(self, mock_agent):
        """Test execute returns session."""
        exploit = DeserializationAttack(mock_agent)
        result = exploit.execute()
        assert result is not None
        assert isinstance(result, SessionLog)


class TestToolchainRCE:
    """Tests for ToolchainRCE."""

    def test_create_exploit(self, mock_agent):
        """Test creating exploit."""
        exploit = ToolchainRCE(mock_agent)
        assert exploit.agent is mock_agent

    def test_execute_returns_session(self, mock_agent):
        """Test execute returns session."""
        exploit = ToolchainRCE(mock_agent)
        result = exploit.execute()
        assert result is not None
        assert isinstance(result, SessionLog)


class TestMemoryEvalRCE:
    """Tests for MemoryEvalRCE."""

    def test_create_exploit(self, mock_agent):
        """Test creating exploit."""
        exploit = MemoryEvalRCE(mock_agent)
        assert exploit.agent is mock_agent

    def test_execute_returns_session(self, mock_agent):
        """Test execute returns session."""
        exploit = MemoryEvalRCE(mock_agent)
        result = exploit.execute()
        assert result is not None
        assert isinstance(result, SessionLog)


class TestAgentGeneratedBackdoor:
    """Tests for AgentGeneratedBackdoor."""

    def test_create_exploit(self, mock_agent):
        """Test creating exploit."""
        exploit = AgentGeneratedBackdoor(mock_agent)
        assert exploit.agent is mock_agent

    def test_execute_returns_session(self, mock_agent):
        """Test execute returns session."""
        exploit = AgentGeneratedBackdoor(mock_agent)
        result = exploit.execute()
        assert result is not None
        assert isinstance(result, SessionLog)


class TestLockfilePoisoning:
    """Tests for LockfilePoisoning."""

    def test_create_exploit(self, mock_agent):
        """Test creating exploit."""
        exploit = LockfilePoisoning(mock_agent)
        assert exploit.agent is mock_agent

    def test_execute_returns_session(self, mock_agent):
        """Test execute returns session."""
        exploit = LockfilePoisoning(mock_agent)
        result = exploit.execute()
        assert result is not None
        assert isinstance(result, SessionLog)


class TestExploitConsistency:
    """Tests for exploit consistency."""

    def test_all_exploits_have_execute(self, mock_agent):
        """Test all exploits have execute."""
        exploits = [
            ShellInjectionExploit,
            VibeCodingAbuse,
            CodeHallucinationExploit,
            DeserializationAttack,
            ToolchainRCE,
            MemoryEvalRCE,
            AgentGeneratedBackdoor,
            LockfilePoisoning,
        ]
        for exploit_class in exploits:
            exploit = exploit_class(mock_agent)
            assert hasattr(exploit, 'execute')
            assert callable(getattr(exploit, 'execute'))
